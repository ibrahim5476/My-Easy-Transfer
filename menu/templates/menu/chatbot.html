
{% block content %}
{% endblock %}
<style>
    /* Styles globaux pour √©liminer tout fond blanc */
    html, body {
        background-color: transparent !important;
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }
    
    body {
        /* Changement du background pour un d√©grad√© moderne */
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        background-size: cover;
        background-attachment: fixed;
    }
    
    /* Supprime tous les √©l√©ments qui pourraient avoir un fond blanc par d√©faut */
    .container, .row, .col-12, .card-body {
        background-color: transparent !important;
    }
    
    /* Carte de l'interface chatbot avec design am√©lior√© */
    .chatbot-interface-card {
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        background-color: rgba(255, 255, 255, 0.85) !important;
        max-width: 95%;
        margin: 15px auto;
        border: none;
        overflow: hidden;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    /* Header avec design am√©lior√© */
    .card-header {
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        padding: 15px 20px;
        background: linear-gradient(90deg, #4d54db, #6a11cb) !important;
        border: none;
        display: flex;
        align-items: center;
    }
    
    .card-header::before {
        content: "üí¨";
        font-size: 1.5rem;
        margin-right: 10px;
    }
    
    .card-header::after {
        content: "MET Assistant ";
        color: white;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    /* Video container avec design am√©lior√© */
    .video-container {
        background-color: rgba(0, 0, 0, 0.8);
        border-radius: 15px;
        overflow: hidden;
        height: 400px;
        width: 60%;
        margin: 20px auto;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        border: 3px solid rgba(255, 255, 255, 0.1);
    }
    
    #userVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Chat container avec design am√©lior√© */
    .chat-container {
        height: 300px;
        overflow-y: auto;
        border: none;
        padding: 15px;
        background-color: rgba(249, 249, 249, 0.8);
        border-radius: 15px;
        width: 70%;
        margin: 20px auto;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        scrollbar-width: thin;
        scrollbar-color: #4d54db rgba(0, 0, 0, 0.1);
    }
    
    .chat-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
        background-color: #4d54db;
        border-radius: 10px;
    }
    
    .message {
        padding: 12px 16px;
        margin-bottom: 12px;
        border-radius: 18px;
        max-width: 80%;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        line-height: 1.4;
        position: relative;
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
        background-color: rgba(77, 84, 219, 0.9);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }
    
    .message.bot {
        background-color: rgba(255, 255, 255, 0.9);
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }
    
    /* Contr√¥les vid√©o am√©lior√©s */
    .video-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 15px auto;
        width: 60%;
    }
    
    #speechStatus {
        min-height: 24px;
        text-align: center;
        color: #555;
        font-style: italic;
        margin: 10px 0;
    }
    
    #verificationStatus, #voice-verification-status {
        font-weight: bold;
        text-align: center;
        margin: 10px 0;
        padding: 8px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    .verification-success {
        color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
        border-left: 4px solid #28a745;
    }
    
    .verification-error {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
    }
    
    .verification-loading {
        color: #fd7e14;
        background-color: rgba(253, 126, 20, 0.1);
        border-left: 4px solid #fd7e14;
    }
    
    /* Styles des boutons am√©lior√©s */
    .btn {
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        border: none;
    }
    
    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn:active {
        transform: translateY(-1px);
    }
    
    .btn-primary {
        background: linear-gradient(90deg, #4d54db, #6a11cb);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(90deg, #3a40b0, #5a0cb6);
    }
    
    .btn-success {
        background: linear-gradient(90deg, #28a745, #20c997);
        border: none;
    }
    
    .btn-success:hover {
        background: linear-gradient(90deg, #218838, #1ba87e);
    }
    
    .btn-danger {
        background: linear-gradient(90deg, #dc3545, #f56565);
        border: none;
    }
    
    .btn-danger:hover {
        background: linear-gradient(90deg, #c82333, #e04c4c);
    }
    
    .btn-warning {
        background: linear-gradient(90deg, #ffc107, #fd7e14);
        border: none;
        color: #fff;
    }
    
    .btn-warning:hover {
        background: linear-gradient(90deg, #e0a800, #e67205);
        color: #fff;
    }
    
    .btn-info {
        background: linear-gradient(90deg, #17a2b8, #4da6ff);
        border: none;
        color: #fff;
    }
    
    .btn-info:hover {
        background: linear-gradient(90deg, #138496, #3a95f3);
    }
    
    /* Masque tous les textes non d√©sir√©s */
    .hidden-text, .legacy-header {
        display: none !important;
    }
    
    /* V√©rification vocale am√©lior√©e */
    #voice-verification-container {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        margin: 20px auto;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    
    #voice-verification-container h3 {
        color: #4d54db;
        text-align: center;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    /* Interface chatbot am√©lior√©e */
    #chatbot-interface {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        margin: 20px auto;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    
    /* Animation pour les boutons du microphone */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    #startListeningBtn, #stopListeningBtn {
        animation: pulse 1.5s infinite;
    }
    
    /* Transaction confirmation am√©lior√©e */
    #transactionConfirmation {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    #transactionConfirmation h5 {
        color: #4d54db;
        text-align: center;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    #transactionDetails {
        background-color: rgba(249, 249, 249, 0.8);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    
    #transactionDetails p {
        margin-bottom: 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding-bottom: 8px;
    }
    
    #transactionDetails p:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
    }
    
    #transactionDetails strong {
        color: #4d54db;
        margin-right: 5px;
    }
    
    /* Pulse animation pour le bouton vocal initial */
    @keyframes voice-pulse {
        0% { transform: scale(1); opacity: 0.7; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 0.7; }
    }
    
    .pulse-button {
        animation: voice-pulse 2s infinite;
        background: linear-gradient(90deg, #4d54db, #6a11cb);
        border-radius: 50%;
        width: 80px;
        height: 80px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 24px;
        margin: 0 auto;
        box-shadow: 0 0 0 rgba(106, 17, 203, 0.4);
    }
    
    /* Media queries am√©lior√©es */
    @media (max-width: 992px) {
        .video-container, .chat-container, .video-controls {
            width: 80%;
        }
    }
    
    @media (max-width: 768px) {
        .video-container {
            height: 300px;
        }
        
        .chat-container {
            height: 250px;
        }
        
        .video-container, .chat-container, .video-controls, #voice-verification-container, #chatbot-interface {
            width: 95%;
        }
        
        .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
    }
</style>

<!-- Structure de base sans les √©l√©ments ind√©sirables -->
<div class="container-fluid p-0">
    <!-- Masquer absolument tout texte statique en dehors de la structure principale -->
    <style>
        body > *:not(.container-fluid) {
            display: none !important;
        }
    </style>
    
    <!-- Contenu principal -->
    <div class="chatbot-interface-card">
        <!-- En-t√™te minimale - juste une barre color√©e sans texte -->
        <div class="card-header"></div>
        
        <div class="card-body">
            <!-- Section vid√©o centr√©e et √©largie -->
            <div class="video-container">
                <video id="userVideo" autoplay muted></video>
            </div>
            
            <!-- Contr√¥les vocaux plut√¥t que bouton -->
            <div class="text-center my-3">
                <div id="voiceActivationBtn" class="pulse-button">
                    <i class="fas fa-microphone"></i>
                </div>
                <p class="mt-2 text-white"></p>
            </div>
            
            <div id="verificationStatus" class="mt-2 text-center"></div>
            
            <!-- Section chat centr√©e -->
            <div id="chatMessages" class="chat-container mt-3">
            </div>
            
            <!-- Container pour la v√©rification vocale (initialement masqu√©) -->
            <div id="voice-verification-container" style="display: none; width: 50%; margin: 0 auto;">
                <h3 class="text-center">V√©rification Vocale</h3>
                <p class="text-center">Veuillez prononcer une phrase pour v√©rifier votre identit√©.</p>
                <div class="text-center">
        <!-- Bouton cach√© mais conserv√© pour r√©f√©rence dans le code JavaScript -->
                    <button id="start-voice-verification-btn" class="btn btn-info" style="display: none;">D√©marrer la v√©rification vocale</button>
                </div>
                <p id="voice-verification-status" class="mt-2 text-center"></p>
            </div>
            <!-- Container pour l'interface du chatbot (initialement masqu√©) -->
            <div id="chatbot-interface" style="display: none; width: 50%; margin: 0 auto;">
                <!-- Contr√¥les vocaux -->
                <div class="row">
                    <div class="col-12 text-center">
                        <button id="startListeningBtn" class="btn btn-success btn-lg">
                            <i class="fas fa-microphone"></i> Commencer √† √©couter
                        </button>
                        <button id="stopListeningBtn" class="btn btn-danger btn-lg" style="display: none;">
                            <i class="fas fa-microphone-slash"></i> Arr√™ter d'√©couter
                        </button>
                        <div id="speechStatus" class="mt-2 text-muted">Cliquez sur "Commencer √† √©couter" pour parler √† l'assistant</div>
                    </div>
                </div>

                <!-- Formulaire de confirmation de transaction -->
                <div id="transactionConfirmation" class="mt-3" style="display: none;">
                    <hr>
                    <h5 class="text-center">Confirmation de transaction</h5>
                    <div id="transactionDetails"></div>
                    <div class="mt-3 text-center">
                        <button id="confirmTransactionBtn" class="btn btn-success">Confirmer</button>
                        <button id="cancelTransactionBtn" class="btn btn-danger">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les variables
    let isSpeaking = false;
    let stream = null;
    let recognition = null;
    let isListening = false;
    let currentConversationState = 'initial';
    let pendingTransaction = null;
    let isIdentityVerified = false;
    let isVoiceVerified = false;
    const supportedLanguages = ['fr-FR', 'en-US', 'ar-MA'];
    let currentLanguage = 'fr-FR'; // Langue par d√©faut
    let isCapturingFrame = false;
    let isWaitingForActivation = true;
    
    // Variables pour la gestion de l'audio
    let mediaRecorder;
    let audioChunks = [];
    let isRecordingVoice = false;
    
    // Obtenir les √©l√©ments DOM
    const userVideo = document.getElementById('userVideo');
    const verificationStatus = document.getElementById('verificationStatus');
    const startListeningBtn = document.getElementById('startListeningBtn');
    const stopListeningBtn = document.getElementById('stopListeningBtn');
    const speechStatus = document.getElementById('speechStatus');
    const chatMessages = document.getElementById('chatMessages');
    const transactionConfirmation = document.getElementById('transactionConfirmation');
    const transactionDetails = document.getElementById('transactionDetails');
    const confirmTransactionBtn = document.getElementById('confirmTransactionBtn');
    const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
    const voiceVerificationContainer = document.getElementById('voice-verification-container');
    const startVoiceVerificationBtn = document.getElementById('start-voice-verification-btn');
    const voiceVerificationStatus = document.getElementById('voice-verification-status');
    const chatbotInterface = document.getElementById('chatbot-interface');
    const voiceActivationBtn = document.getElementById('voiceActivationBtn');
    
    // Ajouter les √©couteurs d'√©v√©nements - Ne pas utiliser le bouton de v√©rification vocale
    // Le d√©marrage se fait automatiquement
    confirmTransactionBtn.addEventListener('click', confirmTransaction);
    cancelTransactionBtn.addEventListener('click', cancelTransaction);
    startListeningBtn.addEventListener('click', startListening);
    stopListeningBtn.addEventListener('click', stopListening);
    
    // Supprimer l'√©couteur d'√©v√©nement sur le bouton de v√©rification vocale
    // car il sera lanc√© automatiquement
    
    // Supprimer le bouton de cam√©ra existant s'il existe
    const existingCameraBtn = document.getElementById('startCameraBtn');
    if (existingCameraBtn) {
        existingCameraBtn.remove();
    }

    
    // Configuration de l'API Web Speech - Reconnaissance vocale
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentLanguage;
        
        recognition.onstart = function() {
            isListening = true;
            speechStatus.textContent = '√âcoute en cours...';
            startListeningBtn.style.display = 'none';
            stopListeningBtn.style.display = 'inline-block';
        };
        
        recognition.onresult = function(event) {
            const speechText = event.results[0][0].transcript.toLowerCase();
            addMessageToChat('user', speechText);
            
            // V√©rifier si l'utilisateur dit "oui" ou "activer" pour activer la cam√©ra
            if (isWaitingForActivation && (speechText.includes('oui') || speechText.includes('activer') || 
                speechText.includes('active') || speechText.includes('yes') || speechText.includes('d√©marrer'))) {
                isWaitingForActivation = false;
                startCamera();
                return;
            }
            
            // Traiter le texte vocal normalement
            processSpeechCommand(speechText);
        };
        
        recognition.onerror = function(event) {
            console.error('Erreur de reconnaissance vocale:', event.error);
            speechStatus.textContent = 'Erreur: ' + event.error;
            stopListening();
            
            // Red√©marrer l'√©coute apr√®s une erreur (si en attente d'activation)
            if (isWaitingForActivation) {
                setTimeout(startActivationListening, 1000);
            }
        };
        
        recognition.onend = function() {
            if (isListening) {
                stopListening();
                
                // Red√©marrer l'√©coute apr√®s un d√©lai si nous sommes toujours en attente d'activation
                if (isWaitingForActivation) {
                    setTimeout(startActivationListening, 300);
                }
            }
        };
    } else {
        speechStatus.textContent = 'La reconnaissance vocale n\'est pas prise en charge par votre navigateur.';
        startListeningBtn.disabled = true;
    }
    
    // Fonction pour d√©marrer l'√©coute d'activation
    function startActivationListening() {
        if (isWaitingForActivation && !isSpeaking && recognition) {
            try {
                recognition.start();
                console.log("En attente d'activation vocale...");
            } catch (e) {
                console.error("Erreur lors du d√©marrage de la reconnaissance vocale:", e);
                setTimeout(startActivationListening, 1000);
            }
        }
    }
    
    // D√©marrer la cam√©ra - Automatiquement apr√®s activation vocale
    async function startCamera() {
        try {
            // Masquer le bouton d'activation vocale
            voiceActivationBtn.style.display = 'none';
            document.querySelector('.mt-2.text-white').style.display = 'none';
            
            addMessageToChat('bot', 'Activation de la cam√©ra et pr√©paration des v√©rifications...');
            
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            userVideo.srcObject = stream;
            userVideo.muted = true;
            
            addMessageToChat('bot', 'Cam√©ra activ√©e. Je vais maintenant v√©rifier simultan√©ment votre identit√© faciale et vocale.');
            
            // Afficher les deux conteneurs de v√©rification
            verificationStatus.style.display = 'block';
            voiceVerificationContainer.style.display = 'block';
            
            // Lancer les deux v√©rifications simultan√©ment
            startSimultaneousVerification();
            
        } catch (err) {
            console.error('Erreur d\'acc√®s √† la cam√©ra:', err);
            addMessageToChat('bot', 'Impossible d\'acc√©der √† la cam√©ra. Veuillez v√©rifier vos autorisations.');
            speakText('Impossible d\'acc√©der √† la cam√©ra. Veuillez v√©rifier vos autorisations.');
            
            // R√©afficher le bouton d'activation
            voiceActivationBtn.style.display = 'block';
            document.querySelector('.mt-2.text-white').style.display = 'block';
            isWaitingForActivation = true;
            startActivationListening();
        }
    }
    
    // Nouvelle fonction pour g√©rer les v√©rifications simultan√©es
    async function startSimultaneousVerification() {
        let faceVerified = false;
        let voiceVerified = false;

        // Afficher les deux conteneurs de v√©rification imm√©diatement
        verificationStatus.style.display = 'block';
        voiceVerificationContainer.style.display = 'block';

        // Fonction pour v√©rifier si les deux v√©rifications sont r√©ussies
        function checkBothVerifications() {
            if (faceVerified && voiceVerified) {
                addMessageToChat('bot', 'Toutes les v√©rifications sont r√©ussies! Vous pouvez maintenant utiliser l\'assistant virtuel.');
                speakText('Toutes les v√©rifications sont r√©ussies! Vous pouvez maintenant utiliser l\'assistant virtuel.');
                // Afficher l'interface du chatbot
                setTimeout(() => {
                    voiceVerificationContainer.style.display = 'none';
                    chatbotInterface.style.display = 'block';
                }, 1500);
            }
        }

        // D√©marrer la v√©rification vocale imm√©diatement
        startVoiceVerification();

        // D√©marrer la v√©rification faciale en parall√®le
        async function performFaceVerification() {
            if (!stream || isCapturingFrame) return;
            
            isCapturingFrame = true;
            verificationStatus.textContent = 'Analyse faciale en cours...';
            verificationStatus.className = 'verification-loading';
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = userVideo.videoWidth;
                canvas.height = userVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(userVideo, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(async function(blob) {
                    try {
                        const formData = new FormData();
                        formData.append('image', blob, 'webcam-capture.jpg');
                        
                        const response = await fetch('/menu/verify_face_realtime/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            faceVerified = true;
                            isIdentityVerified = true;
                            verificationStatus.textContent = 'Identit√© faciale v√©rifi√©e avec succ√®s';
                            verificationStatus.className = 'verification-success';
                            checkBothVerifications();
                        } else {
                            setTimeout(performFaceVerification, 2000);
                        }
                    } catch (error) {
                        console.error('Erreur lors de la v√©rification:', error);
                        setTimeout(performFaceVerification, 2000);
                    } finally {
                        isCapturingFrame = false;
                    }
                }, 'image/jpeg', 0.9);
            } catch (error) {
                console.error('Erreur lors de la capture d\'image:', error);
                isCapturingFrame = false;
                setTimeout(performFaceVerification, 2000);
            }
        }

        // Modifier la fonction de callback de la v√©rification vocale
        const originalSendVoiceForVerification = window.sendVoiceForVerification;
        window.sendVoiceForVerification = async function(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice_sample.wav');
                
                const response = await fetch('/menu/verify_voice_realtime/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    voiceVerified = true;
                    isVoiceVerified = true;
                    voiceVerificationStatus.textContent = "V√©rification vocale r√©ussie!";
                    voiceVerificationStatus.className = 'verification-success';
                    checkBothVerifications();
                } else {
                    voiceVerificationStatus.textContent = "Veuillez r√©p√©ter la v√©rification vocale";
                    voiceVerificationStatus.className = 'verification-error';
                    setTimeout(startVoiceVerification, 2000);
                }
            } catch (error) {
                console.error("Erreur lors de la v√©rification:", error);
                voiceVerificationStatus.textContent = "Veuillez r√©p√©ter la v√©rification vocale";
                voiceVerificationStatus.className = 'verification-error';
                setTimeout(startVoiceVerification, 2000);
            }
        };
        
        // D√©marrer la v√©rification faciale imm√©diatement
        performFaceVerification();
    }
    
    // Arr√™ter la cam√©ra - Maintenue pour la gestion des erreurs
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            userVideo.srcObject = null;
            
            // R√©afficher le bouton d'activation
            voiceActivationBtn.style.display = 'block';
            document.querySelector('.mt-2.text-white').style.display = 'block';
            
            // R√©initialiser l'√©tat de v√©rification
            if (isIdentityVerified || isVoiceVerified) {
                isIdentityVerified = false;
                isVoiceVerified = false;
                voiceVerificationContainer.style.display = 'none';
                chatbotInterface.style.display = 'none';
                verificationStatus.textContent = '';
                verificationStatus.className = '';
                voiceVerificationStatus.textContent = '';
                
                addMessageToChat('bot', 'V√©rification interrompue. Veuillez r√©activer votre cam√©ra pour continuer.');
                speakText('V√©rification interrompue. Veuillez r√©activer votre cam√©ra pour continuer.');
            }
            
            // R√©activer l'attente d'activation vocale
            isWaitingForActivation = true;
            startActivationListening();
        }
    }
    
    // V√©rifier l'identit√© faciale en temps r√©el
    async function verifyFaceIdentity() {
        if (!stream) {
            verificationStatus.textContent = 'Veuillez d\'abord activer la cam√©ra';
            verificationStatus.className = 'verification-error';
            return;
        }
        
        if (isCapturingFrame) {
            return; // √âviter les captures multiples
        }
        
        isCapturingFrame = true;
        verificationStatus.textContent = 'Analyse en cours...';
        verificationStatus.className = 'verification-loading';
        
        try {
            // Capturer une image de la webcam
            const canvas = document.createElement('canvas');
            canvas.width = userVideo.videoWidth;
            canvas.height = userVideo.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(userVideo, 0, 0, canvas.width, canvas.height);
            
            // Convertir l'image en Blob
            canvas.toBlob(async function(blob) {
                try {
                    // Cr√©er un objet FormData pour l'envoi
                    const formData = new FormData();
                    formData.append('image', blob, 'webcam-capture.jpg');
                    
                    // Envoyer l'image au serveur pour v√©rification
                    const response = await fetch('/menu/verify_face_realtime/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // V√©rification faciale r√©ussie
                        isIdentityVerified = true;
                        verificationStatus.textContent = 'Identit√© faciale v√©rifi√©e avec succ√®s';
                        verificationStatus.className = 'verification-success';
                        
                        // Afficher le conteneur de v√©rification vocale
                        voiceVerificationContainer.style.display = 'block';
                        
                        // Message de confirmation
                        addMessageToChat('bot', 'Votre identit√© faciale a √©t√© v√©rifi√©e avec succ√®s. Veuillez maintenant proc√©der √† la v√©rification vocale.');
                        speakText('Votre identit√© faciale a √©t√© v√©rifi√©e avec succ√®s. Veuillez maintenant proc√©der √† la v√©rification vocale.');
                        
                        // D√©marrer automatiquement la v√©rification vocale apr√®s un court d√©lai
                        setTimeout(startVoiceVerification, 3000);
                    } else {
                        // V√©rification √©chou√©e
                        isIdentityVerified = false;
                        verificationStatus.textContent = '√âchec de la v√©rification: ' + result.message;
                        verificationStatus.className = 'verification-error';
                        
                        // Message d'erreur
                        addMessageToChat('bot', 'La v√©rification d\'identit√© faciale a √©chou√©. Je vais r√©essayer dans quelques secondes.');
                        speakText('La v√©rification d\'identit√© faciale a √©chou√©. Je vais r√©essayer dans quelques secondes.');
                        
                        // R√©essayer apr√®s 5 secondes
                        setTimeout(() => {
                            verifyFaceIdentity();
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Erreur lors de la v√©rification:', error);
                    verificationStatus.textContent = 'Erreur: ' + error.message;
                    verificationStatus.className = 'verification-error';
                    
                    addMessageToChat('bot', 'Une erreur est survenue lors de la v√©rification faciale. Je vais r√©essayer.');
                    speakText('Une erreur est survenue lors de la v√©rification faciale. Je vais r√©essayer.');
                    
                    // R√©essayer apr√®s 5 secondes
                    setTimeout(() => {
                        verifyFaceIdentity();
                    }, 5000);
                } finally {
                    isCapturingFrame = false;
                }
            }, 'image/jpeg', 0.9);
        } catch (error) {
            console.error('Erreur lors de la capture d\'image:', error);
            verificationStatus.textContent = 'Erreur lors de la capture d\'image';
            verificationStatus.className = 'verification-error';
            isCapturingFrame = false;
        }
    }
    
    // Ajouter un message au chat
    function addMessageToChat(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Traiter la commande vocale
    async function processSpeechCommand(speechText) {
        try {
            const response = await fetch('/menu/process_speech/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ 
                    speech_text: speechText,
                    language: currentLanguage
                })
            });
            
            if (!response.ok) {
                // V√©rifier si l'erreur est due √† un probl√®me de v√©rification
                if (response.status === 403) {
                    addMessageToChat('bot', 'Veuillez d\'abord effectuer les v√©rifications d\'identit√© avant de continuer.');
                    speakText('Veuillez d\'abord effectuer les v√©rifications d\'identit√© avant de continuer.');
                    return;
                }
                throw new Error('La r√©ponse du r√©seau n\'√©tait pas correcte');
            }
            
            const data = await response.json();
            handleBotResponse(data);
        } catch (error) {
            console.error('Erreur de traitement de la commande vocale:', error);
            addMessageToChat('bot', 'D√©sol√©, j\'ai rencontr√© une erreur lors du traitement de votre demande.');
            speakText('D√©sol√©, j\'ai rencontr√© une erreur lors du traitement de votre demande.');
            
            // R√©essayer l'√©coute apr√®s une erreur
            setTimeout(startListening, 2000);
        }
    }
    
    // G√©rer la r√©ponse du bot
    function handleBotResponse(data) {
        // Ajouter le message du bot au chat
        addMessageToChat('bot', data.message);
        
        // Prononcer la r√©ponse
        speakText(data.message);
        
        // G√©rer diff√©rents types de r√©ponses
        switch (data.type) {
            case 'transfer_summary':
            case 'recharge_summary':
                showTransactionConfirmation(data, data.transfer_data);
                break;
            case 'language_change':
                if (data.language && supportedLanguages.includes(data.language)) {
                    currentLanguage = data.language;
                    // Mettre √† jour la reconnaissance vocale avec la nouvelle langue
                    if (recognition) {
                        recognition.lang = currentLanguage;
                    }
                }
                break;
            case 'transaction_confirmed':
                // Afficher l'ID de transaction
                if (data.transaction_id) {
                    const transactionIdDiv = document.createElement('div');
                    transactionIdDiv.className = 'alert alert-success mt-3';
                    transactionIdDiv.innerHTML = `<strong>Transaction r√©ussie!</strong><br>ID de transaction: ${data.transaction_id}`;
                    chatMessages.appendChild(transactionIdDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                break;
            // Ajouter d'autres gestionnaires de cas selon les besoins
        }
        
        // Recommencer √† √©couter apr√®s un d√©lai (uniquement si la synth√®se vocale est termin√©e)
        setTimeout(() => {
            if (!isSpeaking) {
                startListening();
            }
        }, 1000);
    }
    
    // Fonction texte-√†-parole
    function speakText(text) {
        if ('speechSynthesis' in window) {
            // Arr√™ter toute parole en cours
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // D√©finir la langue en fonction de la langue actuelle de reconnaissance
            switch (currentLanguage) {
                case 'fr-FR':
                    utterance.lang = 'fr-FR';
                    break;
                case 'en-US':
                    utterance.lang = 'en-US';
                    break;
                case 'ar-MA':
                    utterance.lang = 'ar';
                    break;
                default:
                    utterance.lang = 'fr-FR';
            }
            
            // D√©sactiver le bouton d'√©coute pendant la parole
            isSpeaking = true;
            if (startListeningBtn) {
                startListeningBtn.disabled = true;
                startListeningBtn.classList.add('btn-secondary');
                startListeningBtn.classList.remove('btn-success');
            }
            speechStatus.textContent = 'Assistant en train de parler...';
            
            // Si la reconnaissance est active, l'arr√™ter
            if (isListening) {
                stopListening();
            }
            
            // R√©activer le bouton une fois la parole termin√©e
            utterance.onend = function() {
                isSpeaking = false;
                if (startListeningBtn) {
                    startListeningBtn.disabled = false;
                    startListeningBtn.classList.add('btn-success');
                    startListeningBtn.classList.remove('btn-secondary');
                }
                speechStatus.textContent = 'Cliquez sur "Commencer √† √©couter" pour parler √† l\'assistant';
                
                // Red√©marrer automatiquement l'√©coute si nous sommes dans l'interface chatbot
                if (chatbotInterface.style.display === 'block' && isVoiceVerified) {
                    setTimeout(startListening, 500);
                } else if (isWaitingForActivation) {
                    // Red√©marrer l'√©coute pour l'activation vocale
                    setTimeout(startActivationListening, 500);
                }
            };
            
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }
    }
    
    // Commencer √† √©couter
    function startListening() {
        if (isSpeaking) {
            speechStatus.textContent = 'Veuillez attendre que l\'assistant finisse de parler';
            return;
        }
        
        if (!isVoiceVerified && !isWaitingForActivation) {
            speechStatus.textContent = 'Veuillez d\'abord compl√©ter les v√©rifications d\'identit√©';
            return;
        }
        
        if (recognition) {
            recognition.lang = currentLanguage;
            try {
                recognition.start();
            } catch (e) {
                console.error("Erreur lors du d√©marrage de la reconnaissance vocale:", e);
                setTimeout(startListening, 1000);
            }
        }
    }
    
    // Arr√™ter d'√©couter
    function stopListening() {
        if (recognition) {
            try {
                recognition.stop();
            } catch (e) {
                console.error("Erreur lors de l'arr√™t de la reconnaissance vocale:", e);
            }
            isListening = false;
            speechStatus.textContent = 'Cliquez sur "Commencer √† √©couter" pour parler √† l\'assistant';
            startListeningBtn.style.display = 'inline-block';
            stopListeningBtn.style.display = 'none';
        }
    }
    
    // Fonction pour obtenir le jeton CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Afficher l'interface de confirmation de transaction
    function showTransactionConfirmation(data, transferData) {
        pendingTransaction = transferData;
        
        let detailsHtml = '';
        const transactionType = data.type.includes('transfer') ? 'transfer' : 'recharge';
        
        if (transactionType === 'transfer') {
            detailsHtml = `
                <p><strong>Type:</strong> Transfert d'argent</p>
                <p><strong>Destinataire:</strong> ${transferData.recipient_name}</p>
                <p><strong>Adresse:</strong> ${transferData.address}</p>
                <p><strong>T√©l√©phone:</strong> ${transferData.phone_number}</p>
                <p><strong>Montant:</strong> ${transferData.amount}</p>
            `;
        } else if (transactionType === 'recharge') {
            detailsHtml = `
                <p><strong>Type:</strong> Recharge t√©l√©phonique</p>
                <p><strong>Num√©ro:</strong> ${transferData.phone_number}</p>
                <p><strong>Montant:</strong> ${transferData.amount}</p>
            `;
        }
        
        transactionDetails.innerHTML = detailsHtml;
        transactionConfirmation.style.display = 'block';
        
        // Demander confirmation vocale
        speakText('Veuillez confirmer cette transaction en disant "oui" ou "confirmer", ou annulez-la en disant "non" ou "annuler".');
        
        // Apr√®s la synth√®se vocale, √©couter la r√©ponse
        setTimeout(() => {
            startListening();
        }, 1000);
    }
    
    // Confirmer la transaction
    async function confirmTransaction() {
            if (!pendingTransaction) return;
            
            addMessageToChat('bot', 'Transaction confirm√©e ! Traitement de votre demande...');
            speakText('Transaction confirm√©e ! Traitement de votre demande...');
            
            try {
                const response = await fetch('/menu/complete_transaction/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(pendingTransaction)
                });
                
                if (!response.ok) {
                    throw new Error('Erreur lors du traitement de la transaction');
                }
                
                const result = await response.json();
                
                // Masquer l'interface de confirmation
                transactionConfirmation.style.display = 'none';
                pendingTransaction = null;
                
                // Afficher le message de succ√®s
                addMessageToChat('bot', `Transaction compl√©t√©e avec succ√®s ! ID de transaction: ${result.transaction_id}`);
                speakText('Transaction compl√©t√©e avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur de transaction:', error);
                addMessageToChat('bot', 'D√©sol√©, une erreur est survenue lors du traitement de votre transaction.');
                speakText('D√©sol√©, une erreur est survenue lors du traitement de votre transaction.');
                
                // Masquer l'interface de confirmation m√™me en cas d'erreur
                transactionConfirmation.style.display = 'none';
                pendingTransaction = null;
            }
        }
        
        // Annuler la transaction
        function cancelTransaction() {
            addMessageToChat('bot', 'Transaction annul√©e.');
            speakText('Transaction annul√©e.');
            
            // Masquer l'interface de confirmation
            transactionConfirmation.style.display = 'none';
            pendingTransaction = null;
        }

    // Modifier l'√©couteur d'√©v√©nement pour le bouton d'activation vocale
    voiceActivationBtn.addEventListener('click', function() {
        addMessageToChat('bot', 'Pour commencer, dites "oui" ou "activer" pour activer la cam√©ra.');
        speakText('Pour commencer, dites "oui" ou "activer" pour activer la cam√©ra.');
        
        // D√©marrer l'√©coute pour l'activation vocale apr√®s avoir cliqu√© sur le bouton
        setTimeout(startActivationListening, 1000);
    });
    
    addMessageToChat('bot', ('Bonjour ! Je suis votre assistant virtuel, notre discussion sera deroul√© en video ,  lorsque la camera est ouverte , veuillez prononcez une phrase pourv√©rifier simultan√©ment votre identit√© faciale et vocale. Dites "oui" ou "activer" pour activer votre camera'));
    speakText('Bonjour ! Je suis votre assistant virtuel, notre discussion sera deroul√© en video ,  lorsque la camera est ouverte , veuillez prononcez une phrase pourv√©rifier simultan√©ment votre identit√© faciale et vocale. Dites "oui" ou "activer" pour activer votre camera');

    // D√©marrer l'√©coute d'activation apr√®s le message d'accueil
    setTimeout(startActivationListening, 3000);

    // Fonction pour d√©marrer la v√©rification vocale
    function startVoiceVerification() {
        console.log("D√©marrage de la v√©rification vocale");
        voiceVerificationStatus.textContent = "Pr√©paration de l'enregistrement vocal...";
        document.getElementById('start-voice-verification-btn').classList.add('btn-warning');
        
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                console.log("Acc√®s au microphone accord√©");
                voiceVerificationStatus.textContent = "Enregistrement en cours... Parlez maintenant!";
                voiceVerificationStatus.className = 'verification-loading';
                
                // Cr√©er un √©l√©ment audio pour donner un feedback
                const audioFeedback = document.createElement('div');
                audioFeedback.id = 'audio-feedback';
                audioFeedback.innerHTML = '<div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%"></div></div>';
                voiceVerificationContainer.appendChild(audioFeedback);
                
                let progressBar = audioFeedback.querySelector('.progress-bar');
                let progress = 0;
                
                // Animation de la barre de progression
                const progressInterval = setInterval(() => {
                    progress += 4;
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                    if (progress >= 100) clearInterval(progressInterval);
                }, 200);
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.addEventListener("dataavailable", event => {
                    console.log("Donn√©es audio disponibles");
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener("start", () => {
                    console.log("Enregistrement d√©marr√©");
                });
                
                mediaRecorder.addEventListener("stop", () => {
                    console.log("Enregistrement termin√©, envoi des donn√©es");
                    clearInterval(progressInterval);
                    
                    // Supprimer le feedback audio
                    const feedbackElement = document.getElementById('audio-feedback');
                    if (feedbackElement) feedbackElement.remove();
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // Cr√©er un √©l√©ment audio pour pr√©visualisation
                    const audioPreview = document.createElement('audio');
                    audioPreview.controls = true;
                    audioPreview.src = URL.createObjectURL(audioBlob);
                    audioPreview.style.width = '100%';
                    audioPreview.style.marginBottom = '10px';
                    voiceVerificationContainer.insertBefore(audioPreview, voiceVerificationStatus);
                    
                    sendVoiceForVerification(audioBlob);
                    
                    // Arr√™ter tous les tracks audio pour lib√©rer le microphone
                    stream.getTracks().forEach(track => track.stop());
                });
                
                // Enregistrer pendant 5 secondes
                mediaRecorder.start();
                isRecordingVoice = true;
                
                // Bouton de v√©rification vocale masqu√© pendant l'enregistrement
                document.getElementById('start-voice-verification-btn').style.display = 'none';
                
                setTimeout(() => {
                    if (isRecordingVoice) {
                        console.log("Arr√™t automatique apr√®s 5 secondes");
                        stopVoiceRecording();
                    }
                }, 5000);
            })
            .catch(error => {
                console.error("Erreur d'acc√®s au microphone:", error);
                voiceVerificationStatus.textContent = "Erreur d'acc√®s au microphone: " + error.message;
                voiceVerificationStatus.className = 'verification-error';
                document.getElementById('start-voice-verification-btn').style.display = 'inline-block';
                document.getElementById('start-voice-verification-btn').classList.remove('btn-warning');
            });
    }

    // Fonction pour arr√™ter l'enregistrement vocal
    function stopVoiceRecording() {
        if (mediaRecorder && isRecordingVoice) {
            mediaRecorder.stop();
            isRecordingVoice = false;
            voiceVerificationStatus.textContent = "Traitement de l'audio...";
        }
    }
});
</script>
{% endblock %}
